"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[329],{1329:function(t,e,r){r.d(e,{Config:function(){return T},LoginIdentityOperation:function(){return p},OktaProviderConfig:function(){return S},ScopelyId:function(){return z}});for(var i,o,n,s,a,c,d,l,u,g,h,p,v=r(246),y=new Uint8Array(16),f=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,k=[],m=0;m<256;++m)k.push((m+256).toString(16).substr(1));var _=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=(k[t[e+0]]+k[t[e+1]]+k[t[e+2]]+k[t[e+3]]+"-"+k[t[e+4]]+k[t[e+5]]+"-"+k[t[e+6]]+k[t[e+7]]+"-"+k[t[e+8]]+k[t[e+9]]+"-"+k[t[e+10]]+k[t[e+11]]+k[t[e+12]]+k[t[e+13]]+k[t[e+14]]+k[t[e+15]]).toLowerCase();if(!("string"==typeof r&&f.test(r)))throw TypeError("Stringified UUID is invalid");return r},I=function(t,e,r){var i=(t=t||{}).random||(t.rng||function(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(y)})();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,e){r=r||0;for(var o=0;o<16;++o)e[r+o]=i[o];return e}return _(i)};(i=c||(c={})).Pending="pending",i.Error="error",i.Cancel="cancel",i.Success="success",(o=d||(d={})).Apple="APPLE",o.Facebook="FACEBOOK",o.Playstation="PLAYSTATION",o.Google="GOOGLE",o.Xbox="XBOX",o.Okta="OKTA",o.Twitch="TWITCH",(n=l||(l={})).Login="login",n.Signup="signup",n.ResetPwd="reset_pwd",n.DeviceAuthorization="device-authorization",n.LinkAccount="link-account",n.UnlinkAccount="unlink-account",n.Logout="logout",n.EnrollMfa="enroll_mfa",n.UnenrollMfa="unenroll_mfa",n.GetMfa="get_mfa",n.SetPreference="set_preference";class T{constructor(t,e){this.provider=t,this.apiEndpoint=e,this.storage=new v.BN("scopelyid")}}class w{constructor(t,e){this.playgamiTrackingBaseStepCounter=t||0,this.trackingId=e||I()}}class S{getSocialIdentityProvider(t){let e=this.socialLogins.find(e=>e.identityProviderValue===t);if(void 0!==e)return e.provider}getAuthorizeUrl(){return this.endpoint.protocol+"//"+this.endpoint.host+"/oauth2/default/v1/authorize"}getLogoutUrl(){return this.endpoint.protocol+"//"+this.endpoint.host+"/oauth2/default/v1/logout"}constructor(t,e,r,i,o=[]){this.identityProviderName=d.Okta,this.endpoint=new URL(t),this.clientId=e,this.redirectUri=r,this.logoutRedirectUri=i,this.socialLogins=function(t){let e=new Set;for(let r of t){if(e.has(r.identityProviderValue))throw Error("Duplicated identity provider value found");e.add(r.identityProviderValue)}return t}(o)}}var E=r(4508);class P{static fromObject(t){let e,r;let i=null!=t?t:{};i.access_token&&"string"==typeof i.access_token&&(e=i.access_token),i.token_type&&"string"==typeof i.token_type&&(r=i.token_type);let o=new P(e,r);return i.expires_in&&"number"==typeof i.expires_in&&(o.expiresIn=i.expires_in),i.refresh_token&&"string"==typeof i.refresh_token&&(o.refreshToken=i.refresh_token),i.scope&&"string"==typeof i.scope&&(o.scope=i.scope),i.id_token&&"string"==typeof i.id_token&&(o.idToken=i.id_token),o}getAccessToken(){return this.accessToken}getTokenType(){return this.tokenType}getExpiresIn(){return this.expiresIn}getRefreshToken(){return this.refreshToken}getScope(){return this.scope}getIdToken(){return this.idToken}constructor(t,e){if(!t||!e)throw Error("response does not contain any of access_token or token_type");this.accessToken=t,this.tokenType=e}}let C=t=>18e5>Math.abs(new Date().getTime()-t.getTime()),L=(t,e)=>{let r=localStorage.getItem("com.scopely:trackingData"),i=I(),o=1,n=e;if(r){let t=r.split("#");C(new Date(t[3]))&&(i=t[0],o=parseInt(t[1]),o++,n="true"===t[2])}return localStorage.setItem("com.scopely:trackingData","".concat(i,"#").concat(o,"#").concat(n,"#").concat(new Date().toISOString())),{tracking_id:t,tracking_order:o,tracking_group_id:i,force_new_session:n}},O=(t,e,r)=>{let i=L(e,r);return""!==t&&(i.error_message=t),JSON.stringify(i)};class N{loginFunnel(t){let{identityProviderName:e,status:r,trackingId:i,message:o="",forceNewSession:n=!0}=t,s={action:l.Login,provider:e,status:r,status_message:O(o,i,n)};this.tracker.track("sys.scopely_identity",s)}logoutFunnel(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i={action:l.Logout,provider:t,status:e};""!==r&&(i.status_message=r),this.tracker.track("sys.scopely_identity",i)}exportSession(){return this.tracker.exportSession()}constructor(t){this.tracker=t}}class A{moveTo(t){try{let t=window.location.href;this.storage.set(this.LOCAL_STORAGE_LOC_BEFORE_CHANGE_KEY,t)}catch(t){}window.location.href=t}previousLocation(){try{let t=this.storage.get(this.LOCAL_STORAGE_LOC_BEFORE_CHANGE_KEY);if(t)return new URL(t)}catch(t){}}constructor(t){this.LOCAL_STORAGE_LOC_BEFORE_CHANGE_KEY="locationBeforeRedirect",this.storage=t}}class U{constructor(t){this.state=t}}var R=r(8764);let b=(null==window?void 0:window.Buffer)||R.lW;var F=function(t,e,r,i){if("a"===r&&!i)throw TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?i:"a"===r?i.call(t):i?i.value:e.get(t)};(h||(h={})).Logout="logout",(s=p||(p={})).Login="login",s.Link="link";class z{async login(){let{state:t,identityProvider:e,operation:r=p.Login,forceNewSession:i=!0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o="".concat(this.settings.provider.getAuthorizeUrl(),"?");o=(o=(o=(o=(o=o.concat("response_type=code")).concat("&response_mode=query")).concat("&scope=address+openid+email+profile+phone+offline_access")).concat("&redirect_uri=".concat(this.settings.provider.redirectUri))).concat("&client_id=".concat(this.settings.provider.clientId)),i&&(o=o.concat("&prompt=login"));let n=this.settings.provider.identityProviderName,s=!!e,a=s?this.settings.provider.getSocialIdentityProvider(e):void 0;s&&void 0!=a&&(o=o.concat("&idp=".concat(e)),n=a);let d=I();this.setAnalyticsConfig(new w(0,d));let l=F(this,u,"m",g).call(this,null!=t?t:this.randomString(),r,void 0!==a?e:void 0);o=o.concat("&state=".concat(l)),this.scopelyIdTracker.loginFunnel({identityProviderName:n,status:c.Pending,trackingId:this.analyticsConfig.trackingId,forceNewSession:i}),await this.scopelyIdTracker.tracker.flush(),this.locationHandler.moveTo(o)}async logout(t,e){if(void 0===e){let t=this.settings.storage.get(this.ID_TOKEN_KEY);void 0!==t&&(e=t)}if(!e){console.log("Missing id token: will not redirect to logout due to missing parameters");return}let r=I();this.setAnalyticsConfig(new w(0,r));let i=this.settings.provider.logoutRedirectUri;void 0===t&&(t=this.randomString()),t=F(this,u,"m",g).call(this,t,h.Logout);let o="".concat(this.settings.provider.getLogoutUrl(),"?state=").concat(t,"&id_token_hint=").concat(e,"&post_logout_redirect_uri=").concat(i);this.scopelyIdTracker.logoutFunnel(this.settings.provider.identityProviderName,c.Pending),await this.scopelyIdTracker.tracker.flush(),this.locationHandler.moveTo(o)}getGameState(t){var e;return null!==(e=(null==t?void 0:t.split("_"))[1])&&void 0!==e?e:""}getOperationFromState(t){try{return JSON.parse(window.atob(t.split("_")[0])).operation}catch(t){return}}setAnalyticsConfig(t){this.analyticsConfig=t}isLogoutUri(t){return t.startsWith(this.settings.provider.logoutRedirectUri)}async authorizationResult(t){var e;let r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:p.Login,o=E.e.parse(t);if(void 0===o){let t="current uri is not an authorization uri (invalid redirect_uri, state or code)";return this.scopelyIdTracker.loginFunnel({identityProviderName:this.settings.provider.identityProviderName,status:c.Error,trackingId:this.analyticsConfig.trackingId,message:t}),K.errored(t)}let n=this.settings.provider.identityProviderName,s=this.getIdentityProviderInState(o.state);if(void 0!==s){let t=this.settings.provider.getSocialIdentityProvider(s);void 0!==t&&(n=t)}if(!o.isAuthorizationUri(this.settings.provider.redirectUri)){let t="current uri is not an authorization uri (invalid redirect_uri, state or code)";return this.scopelyIdTracker.loginFunnel({identityProviderName:n,status:c.Error,trackingId:this.analyticsConfig.trackingId,message:t}),K.errored(t)}let a=this.settings.provider.redirectUri;r=i===p.Link?"".concat(this.settings.apiEndpoint,"/identity/v1/auth/").concat(this.settings.provider.identityProviderName,"/token"):"".concat(this.settings.apiEndpoint,"/identity/v1/auth/").concat(this.settings.provider.identityProviderName,"/authorize"),r=this.decorateUrlWithTrackingParams(r);let d={code:o.code,redirectUri:a,state:o.state},l=await this.heimdallAuthorization(r,d);if(l.isSuccessful()){this.scopelyIdTracker.loginFunnel({identityProviderName:n,status:c.Success,trackingId:this.analyticsConfig.trackingId});let t=null===(e=l.getResponse())||void 0===e?void 0:e.getIdToken();t&&this.settings.storage.set(this.ID_TOKEN_KEY,t)}else this.scopelyIdTracker.loginFunnel({identityProviderName:n,status:c.Error,trackingId:this.analyticsConfig.trackingId,message:l.getError()});return l}async logoutResult(t){let e=E.U.parse(t,this.settings.provider.logoutRedirectUri);if(!e){let t="current uri is not the logout uri (invalid redirect_uri or state)";return this.scopelyIdTracker.logoutFunnel(this.settings.provider.identityProviderName,c.Error,t),D.errored(t)}let r=D.loggedOut(e.state);return this.settings.storage.remove(this.ID_TOKEN_KEY),r.isSuccessful()?this.scopelyIdTracker.logoutFunnel(this.settings.provider.identityProviderName,c.Success):this.scopelyIdTracker.logoutFunnel(this.settings.provider.identityProviderName,c.Error,r.getError()),r}previousLocation(){return this.locationHandler.previousLocation()}async heimdallAuthorization(t,e){try{let r=await (0,v.H5)(function(){return fetch(t,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},redirect:"follow",body:new URLSearchParams(e)})});if(!r.ok)return this.scopelyIdTracker.loginFunnel({identityProviderName:this.settings.provider.identityProviderName,status:c.Error,trackingId:this.analyticsConfig.trackingId}),K.errored("Scopely Identity Service error: ".concat(r.status," ").concat(r.statusText));{let t=await r.json();return K.authorized(P.fromObject(t))}}catch(t){return K.errored("Unable to authorize with Scopely Identity service due to a network problem: ".concat(t))}}decorateUrlWithTrackingParams(t){let e=new URLSearchParams;e.append("titanApiKey",this.scopelyIdTracker.tracker.getApiKey());let r=this.scopelyIdTracker.tracker.getDeviceToken();return r&&e.append("titanDeviceId",r),"".concat(t,"?").concat(e.toString())}randomString(){return Math.random().toString(36).slice(2)}getIdentityProviderInState(t){try{let e=t.split("_")[0],r=JSON.parse(b.from(e,"base64").toString("utf-8"));if(void 0!==r.provider){let t=this.settings.provider.getSocialIdentityProvider(r.provider);if(void 0!==t)return r.provider}return}catch(t){console.error(t);return}}constructor(t,e,r){u.add(this),this.ID_TOKEN_KEY="idToken",this.settings=t,this.scopelyIdTracker=new N(e),this.locationHandler=new A(t.storage),this.analyticsConfig=new w(0,r||void 0)}}u=new WeakSet,g=function(t,e,r){var i;let o={playgamiTrackingBaseStepCounter:this.analyticsConfig.playgamiTrackingBaseStepCounter,trackingId:this.analyticsConfig.trackingId,operation:e};void 0!==r&&(o.provider=r);let n=(i=JSON.stringify(o),b.from(i).toString("base64")),s=this.scopelyIdTracker.exportSession();return"".concat(n,"_").concat(t,"_").concat(s)};class K{static authorized(t){return new K(t,void 0)}static errored(t){return new K(void 0,t)}isSuccessful(){return void 0===this.error&&void 0!==this.response}getError(){return this.error}getResponse(){return this.response}constructor(t,e){this.response=t,this.error=e}}class D{static loggedOut(t){return new D(t,void 0)}static errored(t){return new D(void 0,t)}isSuccessful(){return void 0===this.error&&void 0!==this.data}getError(){return this.error}getResponse(){return this.data}constructor(t,e){void 0===t?this.data=void 0:this.data=new U(t),this.error=e}}}}]);